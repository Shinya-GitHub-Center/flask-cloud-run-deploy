# About

ã“ã¡ã‚‰ã¯Flaskã‚¢ãƒ—ãƒªã®å‹‰å¼·ç”¨ãƒªãƒã‚¸ãƒˆãƒªã§ã™ã€‚  
å›ºå®šã•ã‚ŒãŸç®¡ç†äººå°‚ç”¨ã®ãƒ­ã‚°ã‚¤ãƒ³IDã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€ç®¡ç†äººã®ã¿ãŒæŠ•ç¨¿ãƒ»å‰Šé™¤ç­‰ãŒã§ãã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ–ãƒ­ã‚°ã‚¢ãƒ—ãƒªã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ©ç”¨ã—ãŸSSRå‹•çš„ã‚¢ãƒ—ãƒªã§ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã—ã®ä¸€ç•ªç°¡å˜ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆç°¡å˜ãªãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã‚‹å€¤ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒªï¼‰ã§å‹‰å¼·ã—ãŸã„å ´åˆã¯ã€åˆ¥é€”[ã“ã¡ã‚‰](https://github.com/Shinya-GitHub-Center/flask-cloud-run-deploy/tree/v1-only-button-click)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- ã¾ãšFlaskã®ã‚·ãƒ³ãƒ—ãƒ«ãªæ©Ÿèƒ½ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ç¢ºèªã™ã‚‹
- æ¬¡ã«æœ¬ç•ªç’°å¢ƒã§ãã¡ã‚“ã¨å‹•ä½œã™ã‚‹ã‹ç¢ºèªã™ã‚‹ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã§ã»ã¼ç„¡æ–™ã§ç¢ºèªã§ãã‚‹ãŸã‚Cloud Runã‚’åˆ©ç”¨ã™ã‚‹ï¼‰

1. uvï¼ˆPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼†ä»®æƒ³ç’°å¢ƒä½œæˆãƒ„ãƒ¼ãƒ«ï¼‰ãŒã‚ãªãŸã®ãƒ­ãƒ¼ã‚«ãƒ«PCã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æã¨ãªã‚Šã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯pythonã®v3.12ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã€äº‹å‰ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§uvã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¨ã‚ˆã„ã§ã™ã­ã€‚
2. ã¾ãšã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€`uv sync`ã‚³ãƒãƒ³ãƒ‰ã«ã¦åˆæœŸåŒ–ã‚’è¡Œã£ã¦ãã ã•ã„ï¼ˆå¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä»¥ä¸‹ã®ä»®æƒ³ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ï¼‰
3. VSCodeã‚„Cursorã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ã§Pythonã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‰ãªã„å ´åˆã¯ã€æ‰‹å‹•ã§`./.venv/bin/python`ã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ã€‚ï¼ˆã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŠã‚ˆã³Pythonã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
4. `uv run flask --app app.main:app db init`ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼‰
5. `uv run flask --app app.main:app db migrate`ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼‰
6. `uv run flask --app app.main:app db upgrade`ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ³¨å…¥ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼‰

Notice: Zipã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸå ´åˆã¯å„è‡ªã§GitåˆæœŸåŒ–ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€å‹‰å¼·ç”¨ãƒ»ãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§ã€ç‰¹ã«`uv.lock`ã¯ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã«å«ã‚ã¦ã„ã¾ã›ã‚“ã®ã§ã€å¸¸ã«æœ€æ–°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦å‹‰å¼·ã—ã¦ãã ã•ã„ã€‚

## é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•æ–¹æ³•
- `uv run run.py`ï¼ˆ__name__ãŒ__main__ã«ãªã‚‹ã®ã§ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒã‚ªãƒ³ã«ãªã‚‹ï¼‰

ï¼ˆæœ¬ç•ªç’°å¢ƒã§gunicornã‚³ãƒãƒ³ãƒ‰ã§èµ·å‹•ã™ã‚‹å ´åˆã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãƒ‘ãƒ¼ãƒ„ã¨ã—ã¦å¯¾è±¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã—ã¦ã„ã‚‹ã ã‘ãªã®ã§ã€__main__ã«ã¯ãªã‚‰ãªã„ï¼‰

## ãƒ–ãƒ­ã‚°ä½¿ç”¨æ–¹æ³•
- ã‚³ãƒŠãƒŸã‚³ãƒãƒ³ãƒ‰ï¼ˆâ†‘â†‘â†“â†“â†â†’â†â†’BAï¼‰ã§ç®¡ç†äººå°‚ç”¨æŠ•ç¨¿ç”»é¢ã‚’ã²ã‚‰ãï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã€`settings.py`ã®USERNAMEã¨PASSWORDã‚’å‚ç…§ï¼‰ã€‚ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã®å ´åˆã¯ã€`/post`ãƒ‘ã‚¹ã¸ç›´æ¥ç§»å‹•ã—ã¦ãã ã•ã„ã€‚
- åˆ¥ã‚³ãƒŠãƒŸã‚³ãƒãƒ³ãƒ‰ï¼ˆâ†â†’â†â†’BAï¼‰ã§ç®¡ç†äººå°‚ç”¨è¨˜äº‹å‰Šé™¤ç”»é¢ã‚’ã²ã‚‰ãï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã€`settings.py`ã®USERNAMEã¨PASSWORDã‚’å‚ç…§ï¼‰ã€‚ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã®å ´åˆã¯ã€`/delete`ãƒ‘ã‚¹ã¸ç›´æ¥ç§»å‹•ã—ã¦ãã ã•ã„ã€‚

## Tips

- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼ˆPython/Flaskï¼‰: app/main.py, app/crud/views.pyãªã©ã®Pythonã‚³ãƒ¼ãƒ‰ã¯ã‚µãƒ¼ãƒãƒ¼ä¸Šã§å®Ÿè¡Œã•ã‚Œã€HTMLã‚’ç”Ÿæˆã—ã¾ã™
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼ˆJavaScriptï¼‰: static/js/scripts.jsã¯ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œã•ã‚Œã€DOMæ“ä½œã€ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã€å‹•çš„ãªç”»é¢æ›´æ–°ãªã©ã‚’è¡Œã„ã¾ã™

# ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€åŠ¹ç‡çš„ãªãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãŸã‚ã«2ã¤ã®é™¤å¤–è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

## `.dockerignore` ã¨ `.gcloudignore` ã®é•ã„

### ãã‚Œãã‚Œã®å½¹å‰²

| ãƒ•ã‚¡ã‚¤ãƒ« | ä½¿ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚° | ç›®çš„ | å½±éŸ¿ç¯„å›² |
|---------|--------------|------|---------|
| `.dockerignore` | Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰æ™‚ | ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®æœ€é©åŒ– | æœ€çµ‚çš„ãªDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¸­èº« |
| `.gcloudignore` | `gcloud run deploy --source .` å®Ÿè¡Œæ™‚ | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è»¢é€é‡ã®å‰Šæ¸› | Cloud Buildã¸ã®é€ä¿¡å†…å®¹ |

### Cloud Runã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
gcloud run deploy utopian-food-blog --source .
```

**ä½¿ç”¨ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:**
- âœ… `.gcloudignore` ã¨ `.dockerignore` ã®ä¸¡æ–¹

**å‹•ä½œ:**
```
ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ­ãƒ¼ã‚«ãƒ« â†’ Cloud Buildã¸é€ä¿¡
  â””â”€ .gcloudignore ã§ãƒ•ã‚£ãƒ«ã‚¿
     ï¼ˆ.venv/, __pycache__/, .git/ ãªã©ã‚’é™¤å¤–ï¼‰

ã‚¹ãƒ†ãƒƒãƒ—2: Cloud Buildä¸Šã§Dockerãƒ“ãƒ«ãƒ‰
  â””â”€ .dockerignore ã§ãƒ•ã‚£ãƒ«ã‚¿
     ï¼ˆpyproject.toml, README.md ãªã©ã‚’é™¤å¤–ï¼‰

ã‚¹ãƒ†ãƒƒãƒ—3: Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤
```

## ãã‚Œãã‚Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã§é™¤å¤–ã™ã‚‹ã‚‚ã®

### `.dockerignore` ã§é™¤å¤–ï¼ˆå®Ÿè¡Œæ™‚ã«ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

```
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ•ã‚¡ã‚¤ãƒ«
pyproject.toml
uv.lock
.python-version

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
README.md
*.md

# é–‹ç™ºãƒ„ãƒ¼ãƒ«è¨­å®š
.vscode/
.idea/
```

**ç†ç”±:** ã“ã‚Œã‚‰ã¯å®Ÿè¡Œæ™‚ã«ä¸è¦ã€‚æœ€çµ‚çš„ãªDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºã‚’å°ã•ãä¿ã¤ã€‚

### `.gcloudignore` ã§é™¤å¤–ï¼ˆè»¢é€ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

```
# é–‹ç™ºç’°å¢ƒã®ä»®æƒ³ç’°å¢ƒï¼ˆã‚µã‚¤ã‚ºãŒå¤§ãã„ï¼‰
.venv/
venv/

# Gitãƒªãƒã‚¸ãƒˆãƒªï¼ˆä¸è¦ï¼‰
.git/

# Pythonã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ï¼‰
__pycache__/

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆé–‹ç™ºç”¨ï¼‰
*.log

# ç’°å¢ƒå¤‰æ•°ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
.env
```

**ç†ç”±:** ã“ã‚Œã‚‰ã‚’Cloud Buildã«é€ä¿¡ã™ã‚‹ã®ã¯ç„¡é§„ã€‚ç‰¹ã«`.venv/`ã¯æ•°ç™¾MBã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã€‚

## `.gitignore` ã¨ã®é–¢ä¿‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ï¼š

> If a `.gcloudignore` file is absent and a `.gitignore` file is present, gcloud will use a generated Git-compatible `.gcloudignore` file that respects your .gitignored files.

ã¤ã¾ã‚Šï¼š
- `.gcloudignore`ãŒãªã„å ´åˆã€`.gitignore`ãŒè‡ªå‹•çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹
- ãŸã ã—ã€**æ˜ç¤ºçš„ã«`.gcloudignore`ã‚’ä½œæˆã™ã‚‹æ–¹ãŒç¢ºå®Ÿ**

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

âœ… **ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«é…ç½®ã™ã‚‹**

```
flask-cloud-run-deploy/
â”œâ”€â”€ .dockerignore      # Dockerãƒ“ãƒ«ãƒ‰ç”¨
â”œâ”€â”€ .gcloudignore      # Cloud Buildãƒ‡ãƒ—ãƒ­ã‚¤ç”¨
â”œâ”€â”€ .gitignore         # Gitç®¡ç†ç”¨
â”œâ”€â”€ Dockerfile
â””â”€â”€ ...
```

## ç¢ºèªæ–¹æ³•

### `.dockerignore` ã®å‹•ä½œç¢ºèª

```bash
# ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
docker build --no-cache -t test-image . 2>&1 | grep "Sending build context"
```

### `.gcloudignore` ã®å‹•ä½œç¢ºèª

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒ­ã‚°ã§è»¢é€ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
gcloud run deploy --source . --dry-run
```

# Google Cloud ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆæœŸè¨­å®š

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Flaskã‚¢ãƒ—ãƒªã‚’Google Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## å‰ææ¡ä»¶

1. Google Cloudã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
2. Google Cloud CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆgcloudï¼‰
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã¨èª²é‡‘ã®æœ‰åŠ¹åŒ–

## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. Google Cloud CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆï¼‰

https://cloud.google.com/sdk/docs/install?hl=ja

ï¼ˆubuntuã®å ´åˆã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å½¢å¼ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ï¼‰

### 2. Google Cloudã®åˆæœŸè¨­å®šãŠã‚ˆã³ãƒ­ã‚°ã‚¤ãƒ³

```bash
gcloud init
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã®ç”»é¢ã¾ã§é€²ã‚“ã ã‚‰ã€ãã“ã§ä¸€æ—¦ä¸­æ–­ã€‚ï¼ˆctrl+cï¼‰

### 3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š

```bash
# æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
gcloud config set project YOUR_PROJECT_ID

# ã¾ãŸã¯æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
gcloud projects create YOUR_PROJECT_ID --name="Flask Test App"
gcloud config set project YOUR_PROJECT_ID
```

### 4. å¿…è¦ãªAPIã‚’æœ‰åŠ¹åŒ–

```bash
gcloud services enable cloudbuild.googleapis.com
gcloud services enable run.googleapis.com
```

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§

## æ¦‚è¦

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã£ã¦è‡ªå‹•çš„ã«æœ¬ç•ªç’°å¢ƒã¨ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚

- **ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ**: SQLiteï¼ˆ`db/blogpost.sqlite`ï¼‰
- **æœ¬ç•ªç’°å¢ƒ**: Google Cloud SQLï¼ˆMySQLï¼‰

## 1. Cloud SQL ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ

gcloudã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã€ä½œæ¥­ã®å‰ã«`gcloud info`ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚  
ï¼ˆsqladmin.googleapis.comã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã¨è¨€ã‚ã‚ŒãŸãŸYESã‚’é¸æŠï¼‰

### MySQL ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼ˆæœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ï¼‰

Cloud SQL ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ  
`gcloud sql instances create utopian-food-blog-db --database-version=MYSQL_8_0 --tier=db-f1-micro --region=asia-northeast1`

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ  
`gcloud sql databases create blogpost --instance=utopian-food-blog-db`

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ  
`gcloud sql users create bloguser --instance=utopian-food-blog-db --password=YOUR_SECURE_PASSWORD`

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

æœ¬ç•ªç’°å¢ƒã«åˆã‚ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
â€»ä»¥ä¸‹ã®æ–¹æ³•ã¯ã‚ã‚“ã©ãã•ã„ã®ã§ä»Šå›ã¯ã‚¹ã‚­ãƒƒãƒ—
- Cloud SQL Proxyã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å®Ÿè¡Œã™ã‚‹æ–¹æ³•
- ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã‹ã‚‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’DBæ¥ç¶šã—ã¦æ³¨å…¥ã™ã‚‹æ–¹æ³•

### Cloud Shellã‚’ä½¿ã†ï¼ˆæœ€ã‚‚ç°¡å˜ãƒ»æ¨å¥¨ï¼‰

### 1. Cloud Shellã‚’èµ·å‹•

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§Google Cloud Consoleã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚
2. ç”»é¢å³ä¸Šã®ã€Œ**Cloud Shellã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹**ã€ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆ`>_`ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ç”»é¢ä¸‹éƒ¨ã«ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¡¨ç¤ºã®æ¨ªã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãŒã‚ã‚‹ã®ã‚’ç¢ºèªï¼‰

### 2. Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¥ç¶š

Cloud Shellã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼š

```bash
gcloud sql connect utopian-food-blog-db --user=bloguser
```

### 3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæ™‚ã«è¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼š

```
Allowlisting your IP for incoming connection for 5 minutes...done.
Connecting to database with SQL user [bloguser].Enter password:
```

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€MySQLãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ`mysql>`ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

### 4. æ¥ç¶šå¾Œã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é¸æŠ

MySQLãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é¸æŠï¼š

```
USE blogpost;
```

### 5. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼‰

MySQLãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ä»¥ä¸‹ã®SQLã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼š  
ï¼ˆå„SQLã‚³ãƒãƒ³ãƒ‰ã‚’ã²ã¨ã¤ã¥ã¤å®Ÿè¡Œï¼‰

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
CREATE TABLE posted (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    contents TEXT NOT NULL,
    create_at DATE
);

-- Alembicã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
CREATE TABLE IF NOT EXISTS alembic_version (
    version_num VARCHAR(32) NOT NULL,
    CONSTRAINT alembic_version_pkc PRIMARY KEY (version_num)
);

-- ç¾åœ¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨˜éŒ²
INSERT INTO alembic_version (version_num) VALUES ('47d32b838e67');
```

### 6. ç¢ºèª

ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£ã—ãä½œæˆã•ã‚ŒãŸã‹ç¢ºèªï¼š

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
SHOW TABLES;

-- postedãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹é€ ã‚’ç¢ºèª
DESCRIBE posted;

-- ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªï¼ˆç©ºã®ã¯ãšï¼‰
SELECT * FROM posted;
```

### 7. çµ‚äº†

```sql
-- MySQLã‹ã‚‰åˆ‡æ–­
exit;
```

### æ³¨æ„ç‚¹

1. **æ¥ç¶šã¯5åˆ†é–“æœ‰åŠ¹**ï¼šCloud Shellã‹ã‚‰ã®æ¥ç¶šã¯ã€è‡ªå‹•çš„ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸€æ™‚çš„ã«è¨±å¯ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã€5åˆ†é–“æœ‰åŠ¹ã§ã™
2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã®ç¢ºèª**ï¼šåˆ¥ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ“ä½œã—ã¦ã„ã‚‹å ´åˆã¯ã€`gcloud config set project PROJECT_ID`ã§åˆ‡ã‚Šæ›¿ãˆ
3. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆ**ï¼šCloud Consoleã‹ã‚‰ã€ã¾ãŸã¯`gcloud sql users set-password`ã§ãƒªã‚»ãƒƒãƒˆå¯èƒ½

## 3. æ¥ç¶šæ–‡å­—åˆ—ã®å–å¾—

### MySQL ã®å ´åˆï¼ˆæœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ï¼‰

```
mysql+pymysql://bloguser:YOUR_SECURE_PASSWORD@/blogpost?unix_socket=/cloudsql/PROJECT_ID:asia-northeast1:utopian-food-blog-db
```

**PROJECT_ID** ã‚’å®Ÿéš›ã® Google Cloud ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

## 4. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ 

`requirements.txt` ã«ã¯ä»¥ä¸‹ãŒæ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ï¼š

### MySQL ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼ˆæœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ï¼‰

```txt
pymysql>=1.1.0
cryptography>=41.0.7
```

## 5. Secret Manager ã§ã®æ©Ÿå¯†æƒ…å ±ã®ç®¡ç†ï¼ˆæ¨å¥¨ï¼‰

### Secret Manager ã‚’æœ‰åŠ¹åŒ–

```bash
gcloud services enable secretmanager.googleapis.com
```

### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œæˆ

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—ï¼ˆMySQLï¼‰
echo -n "mysql+pymysql://bloguser:YOUR_PASSWORD@/blogpost?unix_socket=/cloudsql/PROJECT_ID:asia-northeast1:utopian-food-blog-db" | gcloud secrets create utopian-blog-db-connection --data-file=-

# SECRET_KEYï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆï¼‰
python3 -c "import secrets; print(secrets.token_hex(32))" | gcloud secrets create utopian-blog-secret-key --data-file=-

# ãƒ–ãƒ­ã‚°ã‚¢ãƒ—ãƒªãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼å
echo -n "your_login_name" | gcloud secrets create utopian-blog-admin-username --data-file=-

# ãƒ–ãƒ­ã‚°ã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
echo -n "your_login_password" | gcloud secrets create utopian-blog-admin-password --data-file=-
```
## 6. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆèª­ã¿å–ã‚Šã®æ¨©é™ã‚’ä¸ãˆã‚‹

ã‚³ãƒãƒ³ãƒ‰ã ã¨ã‚ã‚“ã©ãã•ã„ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§è©²å½“ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸Šã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ãã€`default compute service account`ã«Secret Managerã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚µãƒ¼ã®ãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€‚ï¼ˆæ¨©é™â†’ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†â†’ãƒ­ãƒ¼ãƒ«ã‹ã‚‰é¸æŠã§è¿½åŠ ï¼‰

### ğŸ” æ¨©é™ã®èª¬æ˜

- **`roles/secretmanager.secretAccessor`**: Secret Managerã«ä¿å­˜ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„æ¥ç¶šæ–‡å­—åˆ—ãªã©ï¼‰ã‚’èª­ã¿å–ã‚‹æ¨©é™
- **å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: `xxxxxxxxxxxxx-compute@developer.gserviceaccount.com`ï¼ˆCompute Engineã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
- **ã‚¹ã‚³ãƒ¼ãƒ—**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã«ä»˜ä¸

### ğŸ’¡ è£œè¶³

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ`*-compute@developer.gserviceaccount.com`ï¼‰ã¯ã€Google Cloudã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã€Cloud Runãªã©ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒä½¿ç”¨ã—ã¾ã™ã€‚ä»Šå›ã®ã‚ˆã†ã«ã€Secret Managerãªã©ã®ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã¯ã€æ˜ç¤ºçš„ã«æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## 7. Cloud Buildã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤

Secret Manager ã‹ã‚‰å‚ç…§ã—ãªãŒã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š

```bash
gcloud run deploy utopian-food-blog \
    --source . \
    --platform managed \
    --region asia-northeast1 \
    --allow-unauthenticated \
    --add-cloudsql-instances PROJECT_ID:asia-northeast1:utopian-food-blog-db \
    --set-secrets "GCLOUD_DB_CONNECTION=utopian-blog-db-connection:latest,SECRET_KEY=utopian-blog-secret-key:latest,ADMIN_PASSWORD=utopian-blog-admin-password:latest,ADMIN_USERNAME=utopian-blog-admin-username:latest"
```

## 8. å‹•ä½œç¢ºèª

### ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

```bash
gcloud run services describe utopian-food-blog \
    --region asia-northeast1 \
    --format "value(spec.template.spec.containers[0].env)"
```

### ãƒ­ã‚°ã®ç¢ºèª

```bash
gcloud run logs read utopian-food-blog --region asia-northeast1
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **Secret Manager ã‚’ä½¿ç”¨ã™ã‚‹**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ Secret Manager ã«ä¿å­˜
2. **æœ€å°æ¨©é™ã®åŸå‰‡**: Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸
3. **Cloud SQL ã®èªè¨¼ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨**: å…¬é–‹ IP ã‚’é¿ã‘ã€Unix ã‚½ã‚±ãƒƒãƒˆçµŒç”±ã§æ¥ç¶š
4. **SSL/TLS ã‚’æœ‰åŠ¹åŒ–**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’æš—å·åŒ–
5. **å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: Cloud SQL ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆ

1. Cloud SQL ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åãŒæ­£ã—ã„ã‹ç¢ºèª
2. `--add-cloudsql-instances` ãƒ•ãƒ©ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« Cloud SQL Client æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª

```bash
gcloud projects add-iam-policy-binding PROJECT_ID \
    --member="serviceAccount:SERVICE_ACCOUNT@PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/cloudsql.client"
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆ

SQLite ã‹ã‚‰ PostgreSQL/MySQL ã¸ã®ç§»è¡Œæ™‚ã¯ã€ãƒ‡ãƒ¼ã‚¿å‹ã®é•ã„ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
å¿…è¦ã«å¿œã˜ã¦ `models.py` ã®ã‚«ãƒ©ãƒ å®šç¾©ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚

## ã‚³ã‚¹ãƒˆæœ€é©åŒ–

- **db-f1-micro**: ç„¡æ–™æ å¯¾è±¡ï¼ˆæœˆé–“ã®ä½¿ç”¨é‡ã«åˆ¶é™ã‚ã‚Šï¼‰
- **è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: ä½¿ç”¨ã—ãªã„æ™‚é–“å¸¯ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢

```bash
# é–‹ç™ºç’°å¢ƒã§ã¯ã€ä½¿ç”¨ã—ãªã„æ™‚ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢
gcloud sql instances patch utopian-food-blog-db --activation-policy=NEVER
```